<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Azure DevOps Build exception on editing database files during unit test | Development Blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="If you want to edit files within a build, add permissions for it. And set up a periodic build pipeline even if you think you don't need it.">
    <link rel="preload" href="/assets/css/0.styles.3366beeb.css" as="style"><link rel="preload" href="/assets/js/app.9fce4c5b.js" as="script"><link rel="preload" href="/assets/js/14.95cbb687.js" as="script"><link rel="preload" href="/assets/js/7.81758dc8.js" as="script"><link rel="preload" href="/assets/js/19.4d2e4527.js" as="script"><link rel="prefetch" href="/assets/js/10.7d172329.js"><link rel="prefetch" href="/assets/js/11.858e9aef.js"><link rel="prefetch" href="/assets/js/12.43bda00b.js"><link rel="prefetch" href="/assets/js/13.c720ac72.js"><link rel="prefetch" href="/assets/js/15.24d36dab.js"><link rel="prefetch" href="/assets/js/16.bbe3730a.js"><link rel="prefetch" href="/assets/js/17.9067a803.js"><link rel="prefetch" href="/assets/js/18.a9d54df3.js"><link rel="prefetch" href="/assets/js/20.377852dd.js"><link rel="prefetch" href="/assets/js/21.1a5356fb.js"><link rel="prefetch" href="/assets/js/22.2263fda2.js"><link rel="prefetch" href="/assets/js/23.690d475f.js"><link rel="prefetch" href="/assets/js/24.75077c10.js"><link rel="prefetch" href="/assets/js/25.44ad6d96.js"><link rel="prefetch" href="/assets/js/26.c0740a79.js"><link rel="prefetch" href="/assets/js/27.c8c42fe0.js"><link rel="prefetch" href="/assets/js/28.b6b4e667.js"><link rel="prefetch" href="/assets/js/3.5603146a.js"><link rel="prefetch" href="/assets/js/4.f44229da.js"><link rel="prefetch" href="/assets/js/5.323f304f.js"><link rel="prefetch" href="/assets/js/6.be507fb2.js"><link rel="prefetch" href="/assets/js/8.cdea3e40.js"><link rel="prefetch" href="/assets/js/9.c7b91885.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.1bed7082.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3366beeb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section><header id="header"><div class="header-wrapper centered"><div class="title"><a href="/" class="nav-link home-link"><img alt="direkt gruppe" src="/dg-logo.jpg"> <div class="site-name">Development</div></a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li><li class="nav-item"><a href="/static/aboutus/" class="nav-link">About us</a></li><li class="nav-item"><a href="/static/compliancefactory/" class="nav-link">Compliance Factory</a></li></ul></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link"><img alt="direkt gruppe" src="/dg-logo.jpg"> <div class="site-name">Development</div></a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li><li class="mobile-nav-item"><a href="/static/aboutus/" class="nav-link">About us</a></li><li class="mobile-nav-item"><a href="/static/compliancefactory/" class="nav-link">Compliance Factory</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <section class="tag-bar-wrapper"><div id="tag-bar" class="centered"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <div class="links"><a href="/tag/architecture/" class="nav-link">Architecture</a> <a href="/tag/java/" class="nav-link">Java</a> <a href="/tag/spring-boot/" class="nav-link">Spring Boot</a></div></div></section> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><div class="slide"><div class="slide-background" style="background-image:url(/lorem_2.jpg);"><div class="slide-color"><div class="slide-wrapper centered"><div class="content"><h5>Azure DevOps Build exception on editing database files during unit test</h5> <p>If you want to edit files within a build, add permissions for it. And set up a periodic build pipeline even if you think you don't need it.</p> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> <span itemprop="name">Stephanie Reimann</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2020-10-02T00:00:00.000Z">
      2 October 2020
    </time></div> <!----></div> <!----></div></div></div></div></div> <article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><div itemprop="articleBody" class="content__default"><h2 id="project-context"><a href="#project-context" class="header-anchor">#</a> project context</h2> <p>In 2012 we started the development of a customized web application. One component was a webservice that gets some data from a frontend service and does some business stuff (validate, save data, update data, delete data).
In the project we use .Net Framework 4.5, MS SQL and Entity Framework to access the database via code. We also have a seperate project in the solution for unit tests to test the individual methods in the webservice.</p> <p>Later, we started using use Azure DevOps for planing, build and releases. We use a Microsoft-hosted agent. Unit tests are part of the pipeline created in Azure DevOps. After a build was successful, it is automatically deployed to the dev environment. A successful build requires that all unit tests are successful, too.
To avoid extra costs for a database in unit tests, we use a database file (.mdf). During unit tests, data is read from and written to the database.</p> <h2 id="problem"><a href="#problem" class="header-anchor">#</a> problem</h2> <p>When I joined the project, the last code changes were already 1.5 years ago. The pipelines in Azure DevOps were configured. The unit tests were run successfully both locally in Visual Studio and Azure DevOps via the build pipeline.
As you might know from other projects, it takes 1 or maybe even 2 years after acceptance by the customer until further changes are necessary because of new requirements.
This was also the case with this project. After 1.5 years I took over the project from my colleagues. New customer requirements should be implemented in the project.</p> <p>After the necessary code changes had been made, the unit tests in my Visual Studio ran successfully. I was very happy about that. So I had committed the changes to the git of our Azure DevOps. The build pipeline started and I was very excited about the result. To my surprise, the build was not successful because of the unit test step in the pipeline. The deployment to the Dev environment did not take place either. Now the big troubleshooting started.
I looked at the logs and could see that not every test had failed. It only affected the test cases where data is written to the database. Furthermore I could find the following error in each of these test methods:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>System.Data.Entity.Infrastructure.DbUpdateException: An error occurred while updating the entries. See the inner exception for details. ---&gt; System.Data.Entity.Core.UpdateException: An error occurred while updating the entries. See the inner exception for details. ---&gt; System.Data.SqlClient.SqlException: Failed to update database &quot;TestDatabase&quot; because the database is read-only.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Nothing was changed in the database, i.e. the mdf file. So it was obvious that the sudden error must be due to changes in Azure DevOps. The same pipeline running on different microsoft agents show the same error.
Thanks to version control I was able to try the same with the code version, which had worked without problems before. The same error also occurred there. This means only a change in Azure DevOps could have caused the error. I also researched the internet and found nothing that could help me. I also checked the configuration for the database file in the test project:</p> <p><code>data source=(LocalDB)\MSSQLLocalDB;AttachDbFilename=|DataDirectory|\TestDatabase.mdf</code></p> <p>Everything seemed to be correct in the code and in the configuration of the mdf file.
I thought about using a workaround (e.g. using a temporary database in Azure during the tests). But I decided to open a Microsoft Ticket by hoping that Microsoft could tell me how to configure the build so that this database file could be edited during the unit tests while running the pipeline. At this moment I could already imagine that it must be due to some permissions, but I didn't know how to fix it.
About a year after explaining the problem to Microsoft Support, including the creation of a test project, I got the solution - at least for <strong>this</strong> problem...</p> <h2 id="solution"><a href="#solution" class="header-anchor">#</a> solution</h2> <p>The solution is to give the executing user full access permissions. If you have worked with Windows servers in the past, this will probably seem familiar to you.
So I integrated the Powershell command as a further step in the build / yml file:</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token operator">-</span> powershell<span class="token operator">:</span> <span class="token operator">|</span> 
  icacls $<span class="token constant">PWD</span> <span class="token operator">/</span>grant <span class="token string">&quot;$(whoami):(OI)(CI)F&quot;</span> <span class="token operator">/</span><span class="token constant">T</span>
  continueOnError<span class="token operator">:</span> <span class="token boolean">true</span>
  workingDirectory<span class="token operator">:</span> <span class="token function">$</span><span class="token punctuation">(</span>Build<span class="token punctuation">.</span>SourcesDirectory<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>By inserting this step, the unit tests can now also be written into the mdf file and thus the tests can be executed without an external database. However, other errors occurred because the agent no longer matches the used version of .Net Framework. But this is another story... 😈</p> <h2 id="personal-learning-recommendations"><a href="#personal-learning-recommendations" class="header-anchor">#</a> personal learning / recommendations</h2> <ol><li><p>If you want to edit files within a build with custom code, you have to configure permissions in the build with the command I shared here in the post.</p></li> <li><p>Further recommendation is to set up a periodic build pipeline even if you think you don't need it, especially if Microsoft hosted agents are used in the solution pipeline.
A cloud solution is constantly changing. But with a nightly build you are at least made aware of this earlier. You can plan it better with your budget and your other projects. Otherwise, a small change becomes a big change, which you only find out after the actual implementation is completed.</p></li></ol></div> <footer></footer></article></div></div> <div class="mainFooter" data-v-957f1fc4><div class="mainFooter-wrapper centered" data-v-957f1fc4><div class="MainFooterNav-second" data-v-957f1fc4><div class="sec-footerNavFirst" data-v-957f1fc4><p class="headline" data-v-957f1fc4><b data-v-957f1fc4>Contact</b></p> <p data-v-957f1fc4>direkt gruppe GmbH<br data-v-957f1fc4>Tel.: <a href="tel:040881550" data-v-957f1fc4>+49 04 88155-0</a><br data-v-957f1fc4><a href="mailto:info@direkt-gruppe.de" data-v-957f1fc4>info@direkt-gruppe.de</a></p></div> <div class="sec-footerNavSecond" data-v-957f1fc4><p class="headline" data-v-957f1fc4><b data-v-957f1fc4>Hamburg</b></p> <p data-v-957f1fc4>Griegstraße 75, H. 26<br data-v-957f1fc4>22763 Hamburg<br data-v-957f1fc4><a href="https://goo.gl/maps/DwqBiQsFYA1FFFqE8" target="_blank" rel="noopener" data-v-957f1fc4>Find us</a></p></div> <div class="sec-footerNavThird" data-v-957f1fc4><p class="headline" data-v-957f1fc4><b data-v-957f1fc4>Cologne</b></p> <p data-v-957f1fc4>Im Mediapark 6b<br data-v-957f1fc4>50670 Cologne<br data-v-957f1fc4><a href="https://goo.gl/maps/HXsxMWudPimcypCA7" target="_blank" rel="noopener" data-v-957f1fc4>Find us</a></p></div> <div class="sec-footerNavFourth" data-v-957f1fc4><p class="headline" data-v-957f1fc4><b data-v-957f1fc4>Munich</b></p> <p data-v-957f1fc4>Landbaubogen 1<br data-v-957f1fc4>81373 Munich<br data-v-957f1fc4><a href="https://goo.gl/maps/bKpHR6LADAX8zq3a6" target="_blank" rel="noopener" data-v-957f1fc4>Find us</a></p></div> <div class="sec-footerNavFifth" data-v-957f1fc4><p class="headline" data-v-957f1fc4><b data-v-957f1fc4>Paderborn</b></p> <p data-v-957f1fc4>Technologiepark 9<br data-v-957f1fc4>33100 Paderborn<br data-v-957f1fc4><a href="https://goo.gl/maps/N9iehM63fn7zniYx9" target="_blank" rel="noopener" data-v-957f1fc4>Find us</a></p></div></div> <div class="imprint-links" data-v-957f1fc4><a href="https://www.direkt-gruppe.de/impressum/" target="_blank" data-v-957f1fc4>Impressum</a> |
      <a href="https://www.direkt-gruppe.de/datenschutz/" target="_blank" data-v-957f1fc4>Datenschutz</a> |
      <a href="/static/privacy_policy/en/" class="nav-link" data-v-957f1fc4>Privacy Policy</a></div></div></div> <footer class="footer" data-v-12023167><div class="footer-wrapper centered" data-v-12023167><div class="footer-left-wrap" data-v-12023167><ul class="copyright" data-v-12023167><li class="copyright-item" data-v-12023167>
          Copyright © 2020 direkt gruppe GmbH
        </li></ul></div> <div class="footer-right-wrap" data-v-12023167><ul class="contact" data-v-12023167><li class="contact-item" data-v-12023167><a href="https://www.facebook.com/direktgruppe" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-12023167><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-facebook" data-v-12023167><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z" data-v-12023167></path></svg>
            
            </a></li><li class="contact-item" data-v-12023167><a href="https://www.instagram.com/direktgruppe/" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-12023167><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-instagram" data-v-12023167><rect x="2" y="2" width="20" height="20" rx="5" ry="5" data-v-12023167></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z" data-v-12023167></path><line x1="17.5" y1="6.5" x2="17.5" y2="6.5" data-v-12023167></line></svg>
            
            </a></li><li class="contact-item" data-v-12023167><a href="https://www.linkedin.com/company/direkt-gruppe-gmbh/" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-12023167><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-linkedin" data-v-12023167><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z" data-v-12023167></path><rect x="2" y="9" width="4" height="12" data-v-12023167></rect><circle cx="4" cy="4" r="2" data-v-12023167></circle></svg>
            
            </a></li><li class="contact-item" data-v-12023167><a href="https://twitter.com/direkt_gruppe" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-12023167><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter" data-v-12023167><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z" data-v-12023167></path></svg>
            
            </a></li></ul></div></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9fce4c5b.js" defer></script><script src="/assets/js/14.95cbb687.js" defer></script><script src="/assets/js/7.81758dc8.js" defer></script><script src="/assets/js/19.4d2e4527.js" defer></script>
  </body>
</html>
