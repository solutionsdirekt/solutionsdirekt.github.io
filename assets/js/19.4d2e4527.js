(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{483:function(e,t,a){"use strict";a.r(t);var s=a(6),o=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h2",{attrs:{id:"project-context"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#project-context"}},[e._v("#")]),e._v(" project context")]),e._v(" "),a("p",[e._v("In 2012 we started the development of a customized web application. One component was a webservice that gets some data from a frontend service and does some business stuff (validate, save data, update data, delete data).\nIn the project we use .Net Framework 4.5, MS SQL and Entity Framework to access the database via code. We also have a seperate project in the solution for unit tests to test the individual methods in the webservice.")]),e._v(" "),a("p",[e._v("Later, we started using use Azure DevOps for planing, build and releases. We use a Microsoft-hosted agent. Unit tests are part of the pipeline created in Azure DevOps. After a build was successful, it is automatically deployed to the dev environment. A successful build requires that all unit tests are successful, too.\nTo avoid extra costs for a database in unit tests, we use a database file (.mdf). During unit tests, data is read from and written to the database.")]),e._v(" "),a("h2",{attrs:{id:"problem"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#problem"}},[e._v("#")]),e._v(" problem")]),e._v(" "),a("p",[e._v("When I joined the project, the last code changes were already 1.5 years ago. The pipelines in Azure DevOps were configured. The unit tests were run successfully both locally in Visual Studio and Azure DevOps via the build pipeline.\nAs you might know from other projects, it takes 1 or maybe even 2 years after acceptance by the customer until further changes are necessary because of new requirements.\nThis was also the case with this project. After 1.5 years I took over the project from my colleagues. New customer requirements should be implemented in the project.")]),e._v(" "),a("p",[e._v("After the necessary code changes had been made, the unit tests in my Visual Studio ran successfully. I was very happy about that. So I had committed the changes to the git of our Azure DevOps. The build pipeline started and I was very excited about the result. To my surprise, the build was not successful because of the unit test step in the pipeline. The deployment to the Dev environment did not take place either. Now the big troubleshooting started.\nI looked at the logs and could see that not every test had failed. It only affected the test cases where data is written to the database. Furthermore I could find the following error in each of these test methods:")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('System.Data.Entity.Infrastructure.DbUpdateException: An error occurred while updating the entries. See the inner exception for details. ---\x3e System.Data.Entity.Core.UpdateException: An error occurred while updating the entries. See the inner exception for details. ---\x3e System.Data.SqlClient.SqlException: Failed to update database "TestDatabase" because the database is read-only.\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("Nothing was changed in the database, i.e. the mdf file. So it was obvious that the sudden error must be due to changes in Azure DevOps. The same pipeline running on different microsoft agents show the same error.\nThanks to version control I was able to try the same with the code version, which had worked without problems before. The same error also occurred there. This means only a change in Azure DevOps could have caused the error. I also researched the internet and found nothing that could help me. I also checked the configuration for the database file in the test project:")]),e._v(" "),a("p",[a("code",[e._v("data source=(LocalDB)\\MSSQLLocalDB;AttachDbFilename=|DataDirectory|\\TestDatabase.mdf")])]),e._v(" "),a("p",[e._v("Everything seemed to be correct in the code and in the configuration of the mdf file.\nI thought about using a workaround (e.g. using a temporary database in Azure during the tests). But I decided to open a Microsoft Ticket by hoping that Microsoft could tell me how to configure the build so that this database file could be edited during the unit tests while running the pipeline. At this moment I could already imagine that it must be due to some permissions, but I didn't know how to fix it.\nAbout a year after explaining the problem to Microsoft Support, including the creation of a test project, I got the solution - at least for "),a("strong",[e._v("this")]),e._v(" problem...")]),e._v(" "),a("h2",{attrs:{id:"solution"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#solution"}},[e._v("#")]),e._v(" solution")]),e._v(" "),a("p",[e._v("The solution is to give the executing user full access permissions. If you have worked with Windows servers in the past, this will probably seem familiar to you.\nSo I integrated the Powershell command as a further step in the build / yml file:")]),e._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("div",{staticClass:"highlighted"},[e._v("Â ")]),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v(" powershell"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" \n  icacls $"),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("PWD")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("grant "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"$(whoami):(OI)(CI)F"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("T")]),e._v("\n  continueOnError"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("true")]),e._v("\n  workingDirectory"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("Build"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("SourcesDirectory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("p",[e._v("By inserting this step, the unit tests can now also be written into the mdf file and thus the tests can be executed without an external database. However, other errors occurred because the agent no longer matches the used version of .Net Framework. But this is another story... ðŸ˜ˆ")]),e._v(" "),a("h2",{attrs:{id:"personal-learning-recommendations"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#personal-learning-recommendations"}},[e._v("#")]),e._v(" personal learning / recommendations")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("If you want to edit files within a build with custom code, you have to configure permissions in the build with the command I shared here in the post.")])]),e._v(" "),a("li",[a("p",[e._v("Further recommendation is to set up a periodic build pipeline even if you think you don't need it, especially if Microsoft hosted agents are used in the solution pipeline.\nA cloud solution is constantly changing. But with a nightly build you are at least made aware of this earlier. You can plan it better with your budget and your other projects. Otherwise, a small change becomes a big change, which you only find out after the actual implementation is completed.")])])])])}),[],!1,null,null,null);t.default=o.exports}}]);