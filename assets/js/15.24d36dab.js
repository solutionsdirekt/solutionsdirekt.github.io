(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{453:function(e,s,t){e.exports=t.p+"assets/img/cacheoutput.ba707258.png"},454:function(e,s,t){e.exports=t.p+"assets/img/postoutput.b7af6bf7.png"},481:function(e,s,t){"use strict";t.r(s);var a=t(6),n=Object(a.a)({},(function(){var e=this,s=e.$createElement,a=e._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h2",{attrs:{id:"problem"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#problem"}},[e._v("#")]),e._v(" Problem")]),e._v(" "),a("p",[e._v("Für viele Builds müssen Abhängigkeiten installiert werden. Diese Installationen benötigen oft einiges an Zeit.")]),e._v(" "),a("h2",{attrs:{id:"losung"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#losung"}},[e._v("#")]),e._v(" Lösung")]),e._v(" "),a("p",[e._v("Azure DevOps hat seit einiger Zeit ein Feature namens "),a("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/devops/pipelines/release/caching?view=azure-devops",target:"_blank",rel:"noopener noreferrer"}},[e._v("Pipeline caching"),a("OutboundLink")],1),e._v(". Dieses Feature erlaubt es einen Ordner in einem Cache außerhalb des Agents abzulegen. Der Cache bekommt einen Cache Key, der anhand von Identifiern, Dateihashes und Variablen gebildet werden kann.")]),e._v(" "),a("p",[e._v("Ich hatte gerade den Fall, dass für einen Build eine Reihe von Powershell Modulen installiert werden musste. Dies dauert an guten Tagen 5 Minuten pro Build.")]),e._v(" "),a("p",[e._v("Mit einem recht einfachen Yaml Snippet lässt sich das Caching in die Pipeline einbauen:")]),e._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[e._v("    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("job")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" JobName\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("pool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" Hosted VS2017\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("steps")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("task")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" Cache@2\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("inputs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" powershell"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("modules "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("|")]),e._v(" install"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("modules.ps1\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" C"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\\Users\\VssAdministrator\\Documents\\WindowsPowerShell\\Modules\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("cacheHitVar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" CACHE_RESTORED\n\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("task")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" PowerShell@2\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("displayName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" Install Modules\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("inputs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("filePath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" install"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("modules.ps1\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("condition")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" ne(variables.CACHE_RESTORED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" 'true')\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br")])]),a("p",[e._v("Solange die Datei "),a("code",[e._v("install-modules.ps1")]),e._v(" sich nicht verändert wird der "),a("code",[e._v("Install Modules")]),e._v(" Task nicht ausgeführt. Der Cache reduziert die Zeit auf 10 Sekunden.")]),e._v(" "),a("p",[e._v("Der Cachekey wird hier anhand des Fixen strings "),a("code",[e._v("powershell-modules")]),e._v(" und dem Hash der Datei "),a("code",[e._v("install-modules.ps1")]),e._v(".")]),e._v(" "),a("p",[a("img",{attrs:{src:t(453),alt:"Cache Task Output"}})]),e._v(" "),a("p",[e._v("Da es nur ein Cache ist, kann es sein das es noch einzelne Builds gibt, die "),a("code",[e._v("install-modules.ps1")]),e._v(" ausführen müssen, aber für die meisten Fälle ist es deutlich schneller. Dies kann z.B. an der "),a("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/devops/pipelines/release/caching?view=azure-devops#cache-isolation-and-security",target:"_blank",rel:"noopener noreferrer"}},[e._v("Cache isolation"),a("OutboundLink")],1),e._v(" oder weil der Cache nicht mehr verfügbar ist.")]),e._v(" "),a("p",[e._v("Der Cache Task fügt automatisch eine Post job ein. In diesem wird der Inhalt des Ordners unter dem Cachekey hochgeladen.")]),e._v(" "),a("p",[a("img",{attrs:{src:t(454),alt:"Post-job: Cache Task Output"}})]),e._v(" "),a("h2",{attrs:{id:"ausblick"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ausblick"}},[e._v("#")]),e._v(" Ausblick")]),e._v(" "),a("p",[e._v("Mit so einem Cache lassen sich viele Pipeline verbessern. Bei meinen Experimenten mit "),a("code",[e._v("npm")]),e._v(" war leider kein durschlagender Erfolg zu sehen. Da die npm Packages aus so vielen Dateien bestehen, benötigt der Cache Restore leider auch sehr viel Zeit.")])])}),[],!1,null,null,null);s.default=n.exports}}]);